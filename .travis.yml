language: cpp

cache:
  ccache: true
  timeout: 1000

env:
  global:
    - QTVER=5.12.1
    - PPAQTVER=512
    - QTIFWVER=3.0.6
    - APPIMAGEVER=11
    - ARCH_ROOT_DATE=2019.02.01
    - ARCH_ROOT_URL=https://mirror.rackspace.com/archlinux
    - FFMPEG_VERSION=4.1.1
    - RELEASE_BUILD=1

os: osx
osx_image: xcode8
compiler: clang

before_install: |
  if [ -z "${ANDROID_BUILD}" ]; then
    if [ "${TRAVIS_OS_NAME}" = linux ] && [ -z "${ARCH_ROOT_BUILD}" ]; then
      docker pull ${DOCKERIMG}
      docker ps -a
      docker run -it -d -v ${PWD}:/sources -v $HOME/.ccache:/ccache -e CCACHE_DIR=/ccache -w /sources --name ${DOCKERSYS} ${DOCKERIMG} /bin/sh
    elif [ "${TRAVIS_OS_NAME}" = osx ]; then
      brew unlink python
      brew update
      brew upgrade
      brew link --overwrite numpy
    fi
  fi

install:
  - chmod +x ports/ci/travis/install_deps.sh
  - ports/ci/travis/install_deps.sh

before_script: |
  if [ "${ANDROID_BUILD}" = 1 ]; then
    export COMPILESPEC=android-${COMPILER}
  elif [ "${ARCH_ROOT_BUILD}" = 1 ] && [ ! -z "${ARCH_ROOT_MINGW}" ]; then
    export CXX=${ARCH_ROOT_MINGW}-w64-mingw32-g++
    export COMPILESPEC=win32-g++
  elif [ "${TRAVIS_OS_NAME}" = linux ]; then
    if [ "${CXX}" = g++ ]; then
      export COMPILESPEC=linux-g++
    elif [ "${CXX}" = clang++ ]; then
      export COMPILESPEC=linux-clang
    fi
  elif [ "${TRAVIS_OS_NAME}" = osx ]; then
    brew link --force qt5
    if [ "${CXX}" = g++ ]; then
      export COMPILESPEC=macx-g++
    elif [ "${CXX}" = clang++ ]; then
      export COMPILESPEC=macx-clang
    fi
  fi

script:
  - chmod +x ports/ci/travis/build.sh
  - ports/ci/travis/build.sh

after_success:
  - chmod +x ports/ci/travis/deploy.sh
  - ports/ci/travis/deploy.sh

notifications:
  recipients:
    - hipersayan.x@gmail.com
  email:
    on_success: change
    on_failure: change

deploy:
  - provider: releases
    api_key:
      secure: qnDcSBgmlBDOt80qfFjIiUdfvm2S8hpOr64dZUweuJHWvKDWP6SPzAwgGi11mVlnFiQkuZD13hygwe3T1pt5fdiwGALSjOcDrg4LFt66rcVczLOD6CUD3/53Dy6feNf1jmUq2Ac8BoNIW/N4qVpYAL2IL4hhCzsz0HcJfxk964d6O6U6mJTRjlLfiQvEH/hT7HZU5oCJHUCxzElm2cgQNFoD5RFuxAjUR6hTjnAx3ToUzGhqIQGy2TH7EFSqYWC1c8aJaHCevk/kkj3stEi6UB6t/EewDiiNiU+LNk5QEZRF6t1B8BpS/3CjLR9IxzaZebdJtMNVf4jfurWYy4h4uLkzcGyBhufIZv+rGkK+Du0dvMME7S7gVM7sT6Y63EVKlUn1v4FK+Acn243f6N+8SEhpgYn0hr3aFwH0TiG/wYYdE+3w9wOpgk2jEdEqpzuQPDk2HUuXBr284FiyFSPUaMHXgJ0VtKLRkcSezSbbEIzwbRSJBZdh4grB1OdQDzyzoHyDQbfa6CWj2AjOBuzGZ9KYJrocrr13q1iAyfUQvVs1T/guX4sc1VGV839ajBB6CQYKNh03wAf989RrdAx7+Zeiga/Z36L28nvcAd1Xy/VMCl4Is2eqMLojKr7wb8p/ADKv/C6yX/ULNG7OWA/lOOf/7PKlpBSsUJgPzdzypCY=
    file_glob: true
    file:
      - $TRAVIS_BUILD_DIR/ports/deploy/packages_auto/*/*
    skip_cleanup: true
    overwrite: true
    draft: true
    on:
      tags: true
      branch: master
      condition: $RELEASE_BUILD = 1
      repo: webcamoid/webcamoid
